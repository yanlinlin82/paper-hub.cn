<!DOCTYPE html>{% load static %}{% load view_extras %}{% load tz %}{% timezone 'Asia/Shanghai' %}
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper-Hub</title>
  <meta name="google-site-verification" content="CJeulU9yTowOBo-3EpJYEAhlHcG1NAHauYkG4LiIVQY">
  <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
  <style>html { scroll-padding-top: 40px; }</style>
</head>

<body>
<a id="top"></a>

<nav class="navbar navbar-expand bg-dark navbar-dark sticky-top py-0">
  <div class="container">
    <a class="navbar-brand" href="/">Paper-Hub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar"
      aria-controls="collapsibleNavbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="collapsibleNavbar">
      <ul class="navbar-nav">
        {% if user.is_authenticated %}
        <li class="nav-item">
          <div class="nav-link text-white">{{ user }}</div>
        </li>
        {% endif %}
        <li class="nav-item">
          {% if user.is_authenticated %}
          <a class="nav-link" href="javascript:logout();">Logout</a>
          {% else %}
          <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a>
          {% endif %}
        </li>
        {% block navbar %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'group:index' %}">Groups</a>
        </li>
        {% endblock navbar %}
      </ul>
    </div>
  </div>
</nav>

<div class="bg-primary text-white">
  <div class="container px-3 py-3 text-center">
    {% block banner %}
    <h2>Paper-Hub</h2>
    <p>Sharing papers with ease and joy!</p>
    {% endblock banner %}
  </div>
</div>

<div class="container" style="margin-top:30px">
  {% block main %}
  <div class="row">
    <div class="col-3">
      <nav class="menu">
        {% block menu %}
        {% endblock menu %}
      </nav>
    </div>
    <div class="col-9">
      <div class="content">
        <article>
          {% if error_message %}
          <div class="alert alert-warning alert-dismissible fade show py-1 rounded-0 mb-0 fixed-top" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close btn-sm align-middle py-2" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
          {% block content %}
          {% endblock content %}
        </article>
      </div>
    </div>
  </div>
  {% endblock main %}
</div>

<footer class="bg-secondary text-white text-center py-3 mt-5">
  <p>&copy; <a class="link-light" href="https://yanlinlin.cn/" target="_blank">Linlin Yan</a>, 2022 - 2023 | <a class="link-light" href="http://beian.miit.gov.cn/" target="_blank">京ICP备18031542号-9</a></p>
  <p>Powered by <a class="link-light" href="https://www.djangoproject.com/" target="_blank">Django</a> &amp; <a class="link-light" href="https://getbootstrap.com/" target="_blank">Bootstrap</a></p>
</footer>

<!-- Scroll-to-top button -->
<div class="scroll-to-top">
  <a href="#top" class="btn btn-primary">
    <span class="glyphicon glyphicon-chevron-up">TOP</span>
  </a>
</div>
<style>
.scroll-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: none;
}
</style>
<script>
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function () {
  scrollFunction();
};
function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
  document.querySelector(".scroll-to-top").style.display = "block";
  } else {
  document.querySelector(".scroll-to-top").style.display = "none";
  }
}
</script>

<!-- jQuery for smooth scrolling -->
<script>
$(document).ready(function () {
  // Add smooth scrolling to all links with the "#top" anchor
  $("a[href='#top']").on('click', function (event) {
    if (this.hash !== "") {
      event.preventDefault();

      var hash = this.hash;

      // Using jQuery's animate() method to add smooth page scroll
      $('html, body').animate({
      scrollTop: $(hash).offset().top
      }, 0, function () {
      // Add hash (#) to URL when done scrolling (default click behavior)
      window.location.hash = hash;
      });
    }
  });
});
</script>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center" id="loginModalLabel">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="loginForm" method="post">
          {% csrf_token %}
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" class="form-control" id="username" name="username" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" class="form-control" id="password" name="password" required />
          </div>
          <input type="hidden" id="ref" name="ref" value="{{ ref }}" />
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancer</button>
        <button type="button" class="btn btn-primary" id="loginButton">Login</button>
      </div>
    </div>
  </div>
</div>
<script>
  $('#loginModal').on('shown.bs.modal', () => {
    $('#username').focus()
  })
  
  $(document).ready(function () {
    $('#loginButton').click(function () {
      function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method)
      }
      var csrf_token = $("input[name='csrfmiddlewaretoken']").val();
      $.ajaxSetup({
        beforeSend: function (xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader('X-CSRFToken', csrf_token)
          }
        }
      })

      var username = $('#username').val()
      var password = $('#password').val()
      $.ajax({
        url: "{% url 'api:login' %}",
        type: 'POST',
        data: {
          username: username,
          password: password
        },
        success: function (data) {
          console.log('ajax return:', data)
          if (!data.success) {
            alert('Login failed. Please check your credentials.')
          } else {
            location.reload(false);
          }
        },
        error: function () {
          // Handle AJAX error
          alert('An error occurred while processing your request.')
        }
      })
    })
  })

  function logout() {
    if (confirm('Are you sure you want to log out?')) {
      $.ajax({
        url: "{% url 'api:logout' %}",
        success: function (data) {
          location.reload(false);
        }
      });
    }
  }
</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1JBLE3S3G0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-1JBLE3S3G0');
</script>

</body>
{% endtimezone %}
</html>
