<!DOCTYPE html>{% load static %}{% load view_extras %}{% load tz %}{% timezone TIME_ZONE %}
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper-Hub</title>
  <meta name="google-site-verification" content="CJeulU9yTowOBo-3EpJYEAhlHcG1NAHauYkG4LiIVQY">
  <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
  <link href="{% static 'bootstrap-5.3.3-dist/css/bootstrap.min.css' %}" rel="stylesheet">
  <script src="{% static 'bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'js/cookie.js' %}"></script>
  <style>html {scroll-padding-top: 40px;}</style>
</head>

<body>
<a id="top"></a>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark py-0">
  <div class="container">
    <a class="navbar-brand" href="{% url 'index' %}">Paper-Hub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar"
      aria-controls="collapsibleNavbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="collapsibleNavbar">
      <ul class="navbar-nav">
        {% if user.is_authenticated %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ user.custom_user.nickname }}
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="javascript:logout();">退出登录</a></li>
          </ul>
        </li>
        {% else %}
        <li class="nav-item">
          <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">登录</a>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<div class="bg-primary text-white">
  <div class="container px-3 py-3">
    {% block banner %}
    <h2>{% block title %}文献宝盒{% endblock title %}</h2>
    <p>{% block subtitle %}一个便捷的用于文献收藏、分享、社群打卡的轻量级在线平台{% endblock subtitle %}</p>
    {% endblock banner %}
  </div>
</div>

<div class="container" style="margin-top:30px">
  {% block main %}
  <div class="row d-flex">
    <nav class="bg-light col-md-3 col-lg-2 d-md-block">
      {% if not CONFIG_XIANGMA_GROUP_ONLY %}
      <div class="list-group text-center">
        <a class="list-group-item list-group-item-dark">探索发现</a>
        <a class="list-group-item list-group-item-action {% if current_page == "search" %}active{% endif %}"
          href="{% url 'search' %}">文献搜索</a>
        <a class="list-group-item list-group-item-action {% if current_page == "recommendations" %}active{% endif %}"
          href="{% url 'recommendations' %}">文献推荐</a>
        <a class="list-group-item list-group-item-action {% if current_page == "recommendations-trash" %}active{% endif %}"
          href="{% url 'recommendations-trash' %}">回收站</a>
        <a class="list-group-item list-group-item-action {% if current_page == "trackings" %}active{% endif %}"
          href="{% url 'trackings' %}">推荐规则</a>
      </div>
      
      <br>
      <div class="list-group text-center">
        <a class="list-group-item list-group-item-dark">个人文献库</a>
        <a class="list-group-item list-group-item-action {% if current_page == "all" %}active{% endif %}"
          href="{% url 'all' %}">全部文献</a>
        <a class="list-group-item list-group-item-action {% if current_page == "recent" %}active{% endif %}"
          href="{% url 'recent' %}">近期文献</a>
      {% if user.is_authenticated and user.is_superuser %}
        <a class="list-group-item list-group-item-action {% if current_page == "trash" %}active{% endif %}"
          href="{% url 'trash' %}">回收站</a>
      {% endif %}
      </div>
      {% endif %}
      
      <br>
      <div class="list-group text-center flex-md-column flex-row">
        <a class="list-group-item list-group-item-dark">社群</a>
        {% if user.is_authenticated and user.is_superuser %}
        <a class="list-group-item list-group-item-action {% if current_page == "group_my_sharing" %}active{% endif %}"
          href="{% url 'group:my_sharing' group_name=group_name %}">我的分享</a>
        {% endif %}
        <a class="list-group-item list-group-item-action {% if current_page == "group_all" %}active{% endif %}"
          href="{% url 'group:all' group_name=group_name %}">所有分享</a>
        <a class="list-group-item list-group-item-action {% if current_page == "group_this_month" %}active{% endif %}"
          href="{% url 'group:this_month' group_name=group_name %}">本月分享</a>
        <a class="list-group-item list-group-item-action {% if current_page == "group_last_month" %}active{% endif %}"
          href="{% url 'group:last_month' group_name=group_name %}">上月分享</a>
        <a class="list-group-item list-group-item-action {% if current_page == "group_stat" %}active{% endif %}"
          href="{% url 'group:stat' group_name=group_name %}">响马榜单</a>
        {% if user.is_authenticated and user.is_superuser %}
        <a class="list-group-item list-group-item-action {% if current_page == "group_trash" %}active{% endif %}"
          href="{% url 'group:trash' group_name=group_name %}">回收站</a>
        {% endif %}
      </div>
    </nav>
    <div class="flex-fill col-md-9 col-lg-10 ms-sm-auto">
      <div class="container">
        <h1 class="mb-4">{% block page_title %}{% endblock page_title %}</h1>
        <p class="text-start">{% block page_subtitle %}{% endblock page_subtitle %}</p>
      </div>
      <div class="content">
        <article>
          {% if error_message %}
          <div class="alert alert-warning alert-dismissible fade show py-1 rounded-0 mb-0 fixed-top" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close btn-sm align-middle py-2" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
          {% block content %}
          {% endblock content %}
        </article>
      </div>
    </div>
  </div>
  {% endblock main %}
</div>

<footer class="bg-secondary text-white text-center py-3 mt-5">
  <p><a class="link-light" href="https://yanlinlin.cn/" target="_blank">&copy; 2022 - 2024</a> | <a class="link-light" href="http://beian.miit.gov.cn/" target="_blank">京ICP备18031542号-9</a> | <a class="link-light" href="https://github.com/yanlinlin.cn/paper-hub.cn/" target="_blank">GitHub</a></p>
<p>基于 <a class="link-light" href="https://www.djangoproject.com/" target="_blank">Django</a> 和 <a class="link-light" href="https://getbootstrap.com/" target="_blank">Bootstrap</a> 开发</p>
</footer>

<!-- Scroll-to-top button -->
<div class="scroll-to-top">
  <a class="btn btn-primary" href="#top">
    <span class="glyphicon glyphicon-chevron-up">TOP</span>
  </a>
</div>
<style>
.scroll-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: none;
}
</style>
<script>
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function () {
  scrollFunction();
};
function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
  document.querySelector(".scroll-to-top").style.display = "block";
  } else {
  document.querySelector(".scroll-to-top").style.display = "none";
  }
}
</script>

<!-- jQuery for smooth scrolling -->
<script>
$(document).ready(function () {
  // Add smooth scrolling to all links with the "#top" anchor
  $("a[href='#top']").on('click', function (event) {
    if (this.hash !== "") {
      event.preventDefault();

      var hash = this.hash;

      // Using jQuery's animate() method to add smooth page scroll
      $('html, body').animate({
      scrollTop: $(hash).offset().top
      }, 0, function () {
      // Add hash (#) to URL when done scrolling (default click behavior)
      window.location.hash = hash;
      });
    }
  });
});
</script>

<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center" id="loginModalLabel">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <nav>
          <div class="nav nav-tabs" id="loginTab" role="tablist">
            <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#username-password" type="button" role="tab" aria-controls="username-password" aria-selected="true">Username/Password</button>
            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#weixin-scan" type="button" role="tab" aria-controls="weixin-scan" aria-selected="false">Weixin Scan</button>
          </div>
        </nav>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="username-password" role="tabpanel" aria-labelledby="home-tab">
            <form id="loginForm" method="post">
              {% csrf_token %}
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" class="form-control" id="username" name="username" required>
              </div>
              <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
              </div>
            </form>
            <!-- Modal footer moved inside the first tab pane -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="loginButton">Login</button>
            </div>
          </div>
          <div class="tab-pane fade" id="weixin-scan" role="tabpanel" aria-labelledby="profile-tab">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  $('#loginModal').on('shown.bs.modal', () => {
    $('#username').focus();
  })

  $('#loginModal').on('keypress', function (event) {
    var keycode = (event.keyCode ? event.keyCode : event.which);
    if (keycode == '13'){
      $('#loginButton').click();   
    }
  });

  $('#loginButton').click(function () {
    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method)
    }
    var csrf_token = $("input[name='csrfmiddlewaretoken']").val();
    $.ajaxSetup({
      beforeSend: function (xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader('X-CSRFToken', csrf_token)
        }
      }
    })

    var username = $('#username').val()
    var password = $('#password').val()

    fetch("{% url 'api:login' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf_token
      },
      body: JSON.stringify({
        username: username,
        password: password
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('fetch return:', data)
      if (!data.success) {
        alert('Login failed. Please check your credentials.')
      } else {
        setCookie('token', data.token, 1);
        location.reload(false);
      }
    })
    .catch(error => {
      // Handle fetch error
      alert('An error occurred while processing your request.', error)
    })
  })
})

function logout() {
  if (confirm('Are you sure you want to log out?')) {
    $.ajax({
      url: "{% url 'api:logout' %}",
      success: function (data) {
        location.reload(false);
      }
    });
  }
}

document.getElementById('profile-tab').addEventListener('click', async function() {
  const currentPageUrl = window.location.href; // 获取当前页面的完整URL
  try {
    const response = await fetch(`/api/get-weixin-qr/?current_url=${encodeURIComponent(currentPageUrl)}`);
    if (!response.ok) {
      throw new Error('Network response was not ok.');
    }
    const data = await response.json();
    const qrFrame = document.getElementById('weixin-scan');
    qrFrame.innerHTML = ''; // 清空可能存在的旧内容
    const iframe = document.createElement('iframe');
    iframe.src = data.url;
    iframe.style.width = '100%';
    iframe.style.height = '400px'; // 调整高度以适应二维码大小
    qrFrame.appendChild(iframe);
  } catch (error) {
    console.error('Error fetching Weixin QR code:', error);
    document.getElementById('weixin-scan').innerHTML = '<p>Error loading QR code. Please try again later.</p>';
  }
});
</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1JBLE3S3G0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-1JBLE3S3G0');
</script>

</body>
{% endtimezone %}
</html>
