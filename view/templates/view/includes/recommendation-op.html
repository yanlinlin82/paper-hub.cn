<div class="modal fade" id="addToLibraryModal" tabindex="-1" aria-labelledby="addToLibraryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addToLibraryModalLabel">加入推荐文献到个人文献库</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addToLibraryModalForm">
          <div class="mb-3">
            <div id="addToLibraryModalInfo" class="text-start"></div>
            <div id="addToLibraryModalTitle" class="text-start mt-3 fs-5 fw-bold"></div>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">笔记</label>
            <textarea class="form-control" id="addToLibraryModalComment" rows="8" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="addToLibraryModalOK">确定</button>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var addToLibraryModal = document.getElementById('addToLibraryModal');
  if (addToLibraryModal) {
    addToLibraryModal.addEventListener('shown.bs.modal', function () {
      var addToLibraryModalComment = document.getElementById('addToLibraryModalComment');
      if (addToLibraryModalComment) {
        addToLibraryModalComment.focus();
      }
    });
  }
});

function expand_recommendations(paper_id) {
  var historicalRecommendations = document.getElementById('historical_recommendations_' + paper_id);
  var expandButton = document.getElementById('button_expand_historical_recommendations_' + paper_id);
  var collapseButton = document.getElementById('button_collapse_historical_recommendations_' + paper_id);
  
  if (historicalRecommendations) {
    historicalRecommendations.classList.add('d-block');
    historicalRecommendations.classList.remove('d-none');
  }
  if (expandButton) {
    expandButton.classList.add('d-none');
    expandButton.classList.remove('d-block');
  }
  if (collapseButton) {
    collapseButton.classList.add('d-block');
    collapseButton.classList.remove('d-none');
  }
}

function collapse_recommendations(paper_id) {
  var historicalRecommendations = document.getElementById('historical_recommendations_' + paper_id);
  var expandButton = document.getElementById('button_expand_historical_recommendations_' + paper_id);
  var collapseButton = document.getElementById('button_collapse_historical_recommendations_' + paper_id);
  
  if (historicalRecommendations) {
    historicalRecommendations.classList.add('d-none');
    historicalRecommendations.classList.remove('d-block');
  }
  if (expandButton) {
    expandButton.classList.add('d-block');
    expandButton.classList.remove('d-none');
  }
  if (collapseButton) {
    collapseButton.classList.add('d-none');
    collapseButton.classList.remove('d-block');
  }
}

function addToLibrary(id) {
  var addToLibraryModalInfo = document.getElementById('addToLibraryModalInfo');
  var addToLibraryModalTitle = document.getElementById('addToLibraryModalTitle');
  var addToLibraryModalComment = document.getElementById('addToLibraryModalComment');
  var addToLibraryModal = document.getElementById('addToLibraryModal');
  var infoElement = document.getElementById('info_' + id);
  var titleElement = document.getElementById('title_' + id + '_text');
  
  if (addToLibraryModalInfo && infoElement) {
    addToLibraryModalInfo.innerHTML = infoElement.innerHTML;
  }
  if (addToLibraryModalTitle && titleElement) {
    addToLibraryModalTitle.innerHTML = titleElement.innerHTML;
  }
  if (addToLibraryModalComment) {
    addToLibraryModalComment.value = '';
  }
  
  if (addToLibraryModal) {
    var modal = new bootstrap.Modal(addToLibraryModal);
    modal.show();
  }

  var addToLibraryModalOK = document.getElementById('addToLibraryModalOK');
  if (addToLibraryModalOK) {
    // Remove existing click listeners and add new one
    addToLibraryModalOK.replaceWith(addToLibraryModalOK.cloneNode(true));
    addToLibraryModalOK = document.getElementById('addToLibraryModalOK');
    
    addToLibraryModalOK.addEventListener('click', function() {
      const comment = addToLibraryModalComment ? addToLibraryModalComment.value : '';
      if (addToLibraryModal) {
        var modal = bootstrap.Modal.getInstance(addToLibraryModal);
        if (modal) {
          modal.hide();
        }
      }
      ajaxPostJson({
        url: "{% url 'api:add_recommendation' %}",
        data: { paper_id: id, comment: comment },
        success: function (data) {
          console.log(data)
          if (!data.success) {
            alert('添加推荐失败！\n' + data.error);
          } else {
            var card = document.getElementById('card_' + id);
            if (card) {
              card.remove();
            }
            var cards = document.querySelectorAll('.card');
            if (cards.length === 0) {
              show_loading_modal('正在刷新页面，请稍候……');
              location.reload();
            }
          }
        }
      });
    });
  }
}

function mark_read_recommendation(id) {
  ajaxPostJson({
    url: "{% url 'api:mark_read_recommendation' %}",
    data: { paper_id: id },
    success: function (data) {
      if (!data.success) {
        alert('mark_read_recommendation failed!\n' + data.error);
      } else {
        var card = document.getElementById('card_' + id);
        if (card) {
          card.remove();
        }
        var cards = document.querySelectorAll('.card');
        if (cards.length === 0) {
          show_loading_modal('正在刷新页面，请稍候……');
          location.reload();
        }
      }
    }
  });
}

function restore_recommendation(id) {
  ajaxPostJson({
    url: "{% url 'api:restore_recommendation' %}",
    data: { paper_id: id },
    success: function (data) {
      if (!data.success) {
        alert('Restore recommendation failed!\n' + data.error);
      } else {
        var card = document.getElementById('card_' + id);
        if (card) {
          card.remove();
        }
        var cards = document.querySelectorAll('.card');
        if (cards.length === 0) {
          show_loading_modal('正在刷新页面，请稍候……');
          location.reload();
        }
      }
    }
  });
}
</script>