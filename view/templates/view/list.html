{% extends "base.html" %}

{% block page_title %}
{% if current_page == "all" %}全部文献{% endif %}
{% if current_page == "recent" %}近期新增{% endif %}
{% if current_page == "trash" %}回收站{% endif %}
{% endblock page_title %}
{% block page_subtitle %}
  当前共 {{ reviews.paginator.count }} 篇文献{% if reviews.paginator.num_pages > 1 %}，本页显示第 {{ reviews.start_index }} - {{ reviews.end_index }} 篇{% endif %}。
{% endblock page_subtitle %}

{% block content %}
{% if reviews %}

{% include "group/paginator.html" %}

{% for item in reviews %}
<div class="card p-2 m-3 d-flex flex-row">
  <div class="p-2 text-start">{{ forloop.counter }}.</div>
  <div class="p-2 flex-fill text-start">
    <div class="text-start">
      {{ item.paper.journal }},
      {{ item.paper.pub_year }}.
      {% if item.paper.doi %}doi: <a href="https://doi.org/{{ item.paper.doi }}" target="_blank">{{ item.paper.doi }}</a>{% endif %}
      {% if item.paper.pmid %}PMID: <a href="https://pubmed.ncbi.nlm.nih.gov/{{ item.paper.pmid }}" target="_blank">{{ item.paper.pmid }}</a>{% endif %}
    </div>
    <div class="mt-2">
      {% for t in item.labels.all %}
      <span class="badge" style="background-color:{{t.color}}">{{ t.name }}</span>
      {% endfor %}
    </div>
    <div class="fs-5 my-3 fw-bold">
      <div><a href="{% url "paper" id=item.pk %}">{{ item.paper.title }}</a><a class="btn btn-secondary mx-3 btn-sm" href="javascript:translate_title({{ item.paper.pk }})">翻译标题</a></div>
      <div id="title_cn_{{ item.paper.pk }}">
      {% if item.paper.translation and item.paper.translation.title_cn %}
      {{ item.paper.translation.title_cn }}
      {% endif %}
      </div>
    </div>
    
    <p>{{ item.author_list | join:", " }}</p>
    {% if item.paper.abstract %}
    <div class="my-3">
      <div><b>Abstract:</b> {{ item.paper.abstract }}<a class="btn btn-secondary mx-3 btn-sm" href="javascript:translate_abstract({{ item.paper.pk }})">翻译摘要</a></div>
      <div id="abstract_cn_{{ item.paper.pk }}">
      {% if item.paper.translation and item.paper.translation.abstract_cn %}
      {{ item.paper.translation.abstract_cn }}
      {% endif %}
      </div>
    </div>
    {% endif %}
    {% if item.paper.keywords %}
    <p><b>Keywords:</b> {{ item.paper.keywords }}</p>
    {% endif %}

    {% if item.comments %}
    <hr>
    <p>{{ item.comments }}</p>
    {% endif %}
  </div>
</div>
{% endfor %}

{% include "group/paginator.html" %}

<script>

function translate_title(paper_id) {
  $('#title_cn_' + paper_id).html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');

  $.ajax({
    url: "{% url 'api:translate_title' %}",
    type: 'POST',
    headers: { "X-CSRFToken": '{{csrf_token}}' },
    data: { paper_id: paper_id },
    success: function (data) {
      console.log(data)
      if (!data.success) {
        alert('Translate title failed!\n' + data.error);
      } else {
        $('#title_cn_' + paper_id).html(data.answer);
      }
    },
    error: function () {
      alert('An error occurred while processing your request.');
    }
  });
}

function translate_abstract(paper_id) {
  $('#abstract_cn_' + paper_id).html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');

  $.ajax({
    url: "{% url 'api:translate_abstract' %}",
    type: 'POST',
    headers: { "X-CSRFToken": '{{csrf_token}}' },
    data: { paper_id: paper_id },
    success: function (data) {
      if (!data.success) {
        alert('Translate title failed!\n' + data.error);
      } else {
        $('#abstract_cn_' + paper_id).html(data.answer);
      }
    },
    error: function () {
      alert('An error occurred while processing your request.');
    }
  });
}
</script>

{% else %}
<p style="padding:20px; height:200px;">No paper is available.</p>
{% endif %}
{% endblock content %}
