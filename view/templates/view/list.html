{% extends "base.html" %}

{% block page_title %}
{% if current_page == "all" %}全部文献{% endif %}
{% if current_page == "recent" %}近期新增{% endif %}
{% if current_page == "trash" %}回收站{% endif %}
{% endblock page_title %}

{% block content %}
<section>
{% if papers %}
  <div class="my-3">
    当前共 {{ papers.paginator.count }} 篇文献{% if papers.paginator.num_pages > 1 %}，本页显示第 {{ papers.start_index }} - {{ papers.end_index }} 篇{% endif %}。
  </div>

  {% include "view/paginator.html" %}

  {% for paper in papers %}
  <div id="card_{{paper.pk}}" class="card p-2 my-3 d-flex flex-row">
    <div class="p-2 text-start">{{ paper.display_index }}.</div>
    <div class="p-2 text-start flex-fill">
      <div class="d-flex">
        <div class="flex-fill">
          <div id="info_{{paper.pk}}" class="text-start">
            {{ paper.journal }},
            {{ paper.pub_date }}.
            {% if paper.doi %}doi: <a href="https://doi.org/{{ paper.doi }}" target="_blank">{{ paper.doi }}</a>{% endif %}
            {% if paper.pmid %}PMID: <a href="https://pubmed.ncbi.nlm.nih.gov/{{ paper.pmid }}" target="_blank">{{ paper.pmid }}</a>{% endif %}
          </div>
        </div>
        <div class="text-end align-self-start">
          <a class="btn btn-primary btn-sm text-nowrap ms-2" href="javascript:alert('not implemented yet');void({{paper.pk}})">星标</a>
        </div>
        <div class="text-end align-self-start">
          <a class="btn btn-danger btn-sm text-nowrap ms-2" href="javascript:alert('not implemented yet');void({{paper.pk}})">删除</a>
        </div>
      </div>
      <div class="mt-2">
        {% for review in paper.review_set.all %}
          {% for label in review.labels.all %}
        <a class="badge" style="background-color:{{label.color}}" href="javascript:void(0)">{{ label.name }}</a>
          {% endfor %}
        {% endfor %}
      </div>
      <div class="my-3">
        <div id="title_{{paper.pk}}" class="d-inline text-start">
          <div id="title_{{paper.pk}}_text" class="d-inline fs-5 fw-bold">{{ paper.title }}</div>
          <a class="ms-2" href="javascript:translate_title({{ paper.pk }}, '{% url 'api:translate_title' %}', '{{csrf_token}}')">翻译</a>
        </div>
        <div id="title_cn_{{ paper.pk }}" class="mt-1 d-none">
        {% if paper.translation and paper.translation.title_cn %}
        {{ paper.translation.title_cn }}
        {% endif %}
        </div>
      </div>

      {% if paper.author_list %}
      <div>
        {% if paper.author_list|length > 10 %}
        <div id="author_{{ paper.pk }}_short" class="d-inline">
          {% for author in paper.author_list|slice:":10" %}
          <a href="{% url 'search' %}?q={{ author|urlencode }}">{{ author }}</a>,
          {% endfor %}
          ...
          <a href="javascript:expand_authors({{ paper.pk }})">&gt;&gt;&gt;</a>
        </div>
        <div id="author_{{ paper.pk }}_long" class="d-none">
          {% for author in paper.author_list %}
          <a href="{% url 'search' %}?q={{ author|urlencode }}">{{ author }}</a>{% if not forloop.last %},{% endif %}
          {% endfor %}
          <a href="javascript:collapse_authors({{ paper.pk }})">&lt;&lt;&lt;</a>
        </div>
        {% else %}
        <div class="d-inline">
          {% for author in paper.author_list %}
          <a href="{% url 'search' %}?q={{ author|urlencode }}">{{ author }}</a>{% if not forloop.last %},{% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      {% if paper.abstract %}
      <div class="my-3">
        <div>
          <b>Abstract:</b>
          {% if paper.abstract|length > 30 %}
          <div id="abstract_{{ paper.pk }}_short" class="d-inline">
            {{ paper.abstract | truncatewords:30 }}
            <a href="javascript:expand_abstract({{paper.pk}})">&gt;&gt;&gt;</a>
          </div>
          <div id="abstract_{{ paper.pk }}_long" class="d-none">
            {{ paper.abstract }}
            <a href="javascript:collapse_abstract({{paper.pk}})">&lt;&lt;&lt;</a>
          </div>
          {% else %}
          <div id="abstract_{{ paper.pk }}_long" class="d-inline">
            {{ paper.abstract }}
          </div>
          {% endif %}
          <a class="ms-2" href="javascript:translate_abstract({{ paper.pk }}, '{% url 'api:translate_abstract' %}', '{{csrf_token}}')">翻译</a>
          <div id="abstract_cn_{{ paper.pk }}" class="mt-1 d-none">
            {% if paper.translation and paper.translation.abstract_cn %}
            {{ paper.translation.abstract_cn }}
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      {% if paper.keyword_list %}
      <div>
        <b>Keywords:</b>
        {% if paper.keyword_list|length > 3 %}
        <div id="keyword_{{ paper.pk }}_short" class="d-inline">
          {% for keyword in paper.keyword_list|slice:":3" %}
          <a href="{% url 'search' %}?q={{ keyword|urlencode }}">{{ keyword }}</a>,
          {% endfor %}
          ...
          <a href="javascript:expand_keywords({{ paper.pk }})">&gt;&gt;&gt;</a>
        </div>
        <div id="keyword_{{ paper.pk }}_long" class="d-none">
          {% for keyword in paper.keyword_list %}
          <a href="{% url 'search' %}?q={{ keyword|urlencode }}">{{ keyword }}</a>{% if not forloop.last %},{% endif %}
          {% endfor %}
          <a href="javascript:collapse_keywords({{ paper.pk }})">&lt;&lt;&lt;</a>
        </div>
        {% else %}
        <div class="d-inline">
          {% for keyword in paper.keyword_list %}
          <a href="{% url 'search' %}?q={{ keyword|urlencode }}">{{ keyword }}</a>{% if not forloop.last %},{% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
      <hr>
      <div class="mt-2">
        <div>共 {{ paper.reviews | length }} 条笔记：</div>
        <ul>
        {% for review in paper.reviews %}
          <li class="my-2">
            <div class="d-inline text-start my-2">{{ review.create_time | date:"Y-m-d H:i" }}：</div>
            <div class="d-inline text-start my-2">{{ review.comments }}</div>
          </li>
        {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  {% endfor %}
{% include "view/paginator.html" %}
{% else %}
  <p style="padding:20px; height:200px;">No paper is available.</p>
{% endif %}
</section>
{% endblock content %}
