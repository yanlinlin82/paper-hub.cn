{% extends "base.html" %}

{% block page_title %}文献推荐{% if current_page == "recommendations-trash" %}（回收站）{% endif %}{% endblock page_title %}
{% block page_subtitle %}{% autoescape off %}{{ summary_messages }}{% endautoescape %}当前共推荐 {{ reviews.paginator.count }} 篇文献{% if reviews.paginator.num_pages > 1 %}，本页显示第 {{ reviews.start_index }} - {{ reviews.end_index }} 篇{% endif %}。{% endblock page_subtitle %}

{% block content %}
{% if reviews %}

{% include "group/paginator.html" %}

{% for item in reviews %}
<div id="card_{{item.pk}}" class="card p-2 m-3 d-flex flex-row">
  <div class="p-2 text-start">{{ item.display_index }}.</div>
  <div class="p-2 flex-fill text-start">
    <div class="text-start">
      {{ item.paper.journal }},
      {{ item.paper.pub_year }}.
      {% if item.paper.doi %}doi: <a href="https://doi.org/{{ item.paper.doi }}" target="_blank">{{ item.paper.doi }}</a>{% endif %}
      {% if item.paper.pmid %}PMID: <a href="https://pubmed.ncbi.nlm.nih.gov/{{ item.paper.pmid }}" target="_blank">{{ item.paper.pmid }}</a>{% endif %}
    </div>
    <div class="mt-2">
      {% for d in item.details.all %}
      <a class="badge" style="background-color:{{d.label.color}}" data-bs-toggle="tooltip" title="{{d.recommend_time | date:"Y-m-d H:i"}}" href="#">{{ d.label.name }}</a>
      {% endfor %}
    </div>
    <div class="fs-5 my-3 fw-bold">
      <div>{{ item.paper.title }}<a class="btn btn-secondary mx-3 btn-sm" href="javascript:translate_title({{ item.paper.pk }})">翻译标题</a></div>
      <div id="title_cn_{{ item.paper.pk }}">
      {% if item.paper.translation and item.paper.translation.title_cn %}
      {{ item.paper.translation.title_cn }}
      {% endif %}
      </div>
    </div>
    
    <div>{{ item.author_list | join:", " }}</div>
    {% if item.paper.abstract %}
    <div class="my-3">
      <div><b>Abstract:</b> {{ item.paper.abstract }}<a class="btn btn-secondary mx-3 btn-sm" href="javascript:translate_abstract({{ item.paper.pk }})">翻译摘要</a></div>
      <div id="abstract_cn_{{ item.paper.pk }}">
      {% if item.paper.translation and item.paper.translation.abstract_cn %}
      {{ item.paper.translation.abstract_cn }}
      {% endif %}
      </div>
    </div>
    {% endif %}
    {% if item.paper.keywords %}
    <div><b>Keywords:</b> {{ item.paper.keywords }}</div>
    {% endif %}
    <div class="d-flex my-2">
      <div class="text-start align-self-end">推送时间：{{ item.create_time | date:"Y-m-d H:i" }}</div>
      <div class="flex-fill text-end align-self-end">
        {% if current_page == "recommendations" %}
        <a class="btn btn-primary" href="javascript:add_recommendation({{item.pk}})">加入个人文献库</a>
        <a class="btn btn-danger" href="javascript:delete_recommendation({{item.pk}})">删除</a>
        {% else %}
        <a class="btn btn-primary" href="javascript:restore_recommendation({{item.pk}})">恢复</a>
        <a class="btn btn-danger" href="javascript:delete_permanently_recommendation({{item.pk}})">彻底删除</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% include "group/paginator.html" %}

<script>

function add_recommendation(id) {
  if (confirm('Are you sure to add the item?')) {
    $.ajax({
      url: "{% url 'api:add_recommendation' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { recommendation_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Delete recommendation failed!\n' + data.error);
        } else {
          $('#card_' + id).remove();
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}

function delete_recommendation(id) {
  if (confirm('Are you sure to delete the item?')) {
    $.ajax({
      url: "{% url 'api:delete_recommendation' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { recommendation_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Delete recommendation failed!\n' + data.error);
        } else {
          $('#card_' + id).remove();
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}

function restore_recommendation(id) {
  if (confirm('Are you sure to restore the item?')) {
    $.ajax({
      url: "{% url 'api:restore_recommendation' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { recommendation_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Restore recommendation failed!\n' + data.error);
        } else {
          $('#card_' + id).remove();
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}

function delete_permanently_recommendation(id) {
  if (confirm('Are you sure to delete the item permanently?')) {
    $.ajax({
      url: "{% url 'api:delete_permanently_recommendation' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { recommendation_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Delete permanently recommendation failed!\n' + data.error);
        } else {
          $('#card_' + id).remove();
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}

function translate_title(paper_id) {
  $('#title_cn_' + paper_id).html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');

  $.ajax({
    url: "{% url 'api:translate_title' %}",
    type: 'POST',
    headers: { "X-CSRFToken": '{{csrf_token}}' },
    data: { paper_id: paper_id },
    success: function (data) {
      console.log(data)
      if (!data.success) {
        alert('Translate title failed!\n' + data.error);
      } else {
        $('#title_cn_' + paper_id).html(data.answer);
      }
    },
    error: function () {
      alert('An error occurred while processing your request.');
    }
  });
}

function translate_abstract(paper_id) {
  $('#abstract_cn_' + paper_id).html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');

  $.ajax({
    url: "{% url 'api:translate_abstract' %}",
    type: 'POST',
    headers: { "X-CSRFToken": '{{csrf_token}}' },
    data: { paper_id: paper_id },
    success: function (data) {
      if (!data.success) {
        alert('Translate title failed!\n' + data.error);
      } else {
        $('#abstract_cn_' + paper_id).html(data.answer);
      }
    },
    error: function () {
      alert('An error occurred while processing your request.');
    }
  });
}

</script>
{% else %}
<div class="container">
  <div class="d-flex">
    <div class="flex-fill text-middle">
      暂无推荐文献。建议<a href="{% url "trackings" %}">添加推荐规则</a>，以便后续系统识别到符合条件的文献时进行推送。
    </div>
  </div>
</div>
{% endif %}
{% endblock content %}
