{% extends "group/base.html" %}
{% load view_extras %}
{% load static %}

{% block banner %}
<div class="text-start">
  <a class="navbar-brand fs-2" href="/group/{{ group.name }}">{{ group.display_name }}</a>
  <p>{{ group.desc }}</p>
</div>
{% endblock banner %}

{% block content %}
<div class="p-2 text-start flex-fill">
  {% include "group/review-info.html" %}
  <div class="my-3">{{ review.comment }}</div>
  {% with review.paper as paper %}
  <div id="card_{{ paper.pk }}" class="card p-2">
    <div id="info_{{ paper.pk }}" class="text-start">
      <div class="flex-fill">{% include "group/paper-info.html" %}</div>
    </div>
    <div class="my-2">
      <div id="title_{{ paper.pk }}" class="d-inline text-start">
        <div id="title_{{ paper.pk }}_text" class="d-inline fs-5 fw-bold">{{ paper.title }}</div>
        <a class="ms-2" href="javascript:translate_title({{ paper.pk }})">翻译</a>
      </div>
      <div id="title_cn_{{ paper.pk }}" class="mt-1 d-none">
      {% if paper.translation and paper.translation.title_cn %}
      {{ paper.translation.title_cn }}
      {% endif %}
      </div>
    </div>

    {% if paper.author_list %}
    <div>
      {% if paper.author_list|length > 10 %}
      <div id="author_{{ paper.pk }}_short" class="d-inline">
        {% for author in paper.author_list|slice:":10" %}
        <a href="{% if user.is_authenticated %}{% url 'search' %}?q={{ author|urlencode }}{% else %}javascript:void(0);{% endif %}">{{ author }}</a>,
        {% endfor %}
        ...
        <a href="javascript:expand_authors({{ paper.pk }})">&gt;&gt;&gt;</a>
      </div>
      <div id="author_{{ paper.pk }}_long" class="d-none">
        {% for author in paper.author_list %}
        <a href="{% if user.is_authenticated %}{% url 'search' %}?q={{ author|urlencode }}{% else %}javascript:void(0);{% endif %}">{{ author }}</a>{% if not forloop.last %},{% endif %}
        {% endfor %}
        <a href="javascript:collapse_authors({{ paper.pk }})">&lt;&lt;&lt;</a>
      </div>
      {% else %}
      <div class="d-inline">
        {% for author in paper.author_list %}
        <a href="{% if user.is_authenticated %}{% url 'search' %}?q={{ author|urlencode }}{% else %}javascript:void(0);{% endif %}">{{ author }}</a>{% if not forloop.last %},{% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}
    
    <div class="my-3">
      <div>
        <b>Abstract:</b>
      </div>
      <div>
        {% if paper.abstract %}
        <div id="abstract_{{ paper.pk }}_long" class="d-inline">
          {{ paper.abstract }}
        </div>
        <a class="ms-2" href="javascript:translate_abstract({{ paper.pk }})">翻译</a>
        <div id="abstract_cn_{{ paper.pk }}" class="mt-1 d-none">
          {% if paper.translation and paper.translation.abstract_cn %}
          {{ paper.translation.abstract_cn }}
          {% endif %}
        </div>
        {% else %}
        <i>No abstract available.</i>
        {% endif %}
      </div>
    </div>

    {% if paper.keyword_list %}
    <div>
      <b>Keywords:</b>
      <div class="d-inline">
        {% for keyword in paper.keyword_list %}
        <a href="{% if user.is_authenticated %}{% url 'search' %}?q={{ keyword|urlencode }}{% else %}javascript:void(0);{% endif %}">{{ keyword }}</a>{% if not forloop.last %},{% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if review.paper.urls %}
    <div class="mt-3">
      <div class="url-label"><b>Related Links:</b></div>
      <div class="url-item"><ul>
        {% with review.paper.urls|splitlines as urls %}
        {% for u in urls %}
        <li><a href="{{ u }}" target="_blank" class="external-link">{{ u }}</a></li>
        {% endfor %}
        {% endwith %}
      </ul></div>
    </div>
    {% endif %}
  </div>
  {% endwith %}
</div>

{% include "group/review-info-js.html" %}
{% include "view/paper-js.html" %}

{% if user.is_authenticated %}
<form method="post">
<button type="button" id="summarize-by-gpt" class="btn btn-outline-info btn-sm">Summarize by ChatGPT</button>
<textarea id="gpt-answer" class="form-control" style="width:100%;min-height:200px;"></textarea>
</form>
<script>
document.getElementById('summarize-by-gpt').addEventListener('click', function() {
  const abortController = new AbortController();
  const signal = abortController.signal;
  show_loading_modal('正在通过 ChatGPT 对文献进行总结...', true, '取消', function() {
    abortController.abort();
    hide_loading_modal();
  });
  const token = getCookie('token');
  const postData = {
    paper_id: '{% if review.paper.doi %}{{ review.paper.doi }}{% else %}{% if review.paper.arxiv_id %}{{ review.paper.arxiv_id }}{% else %}{% if review.paper.pmid %}{{ review.paper.pmid }}{% else %}{{ review.pk }}{% endif %}{% endif %}{% endif %}',
    token: token,
    group_name: '{{ group.name }}'
  };
  ajaxPostJson({
    url: '/api/summarize_by_gpt',
    data: postData,
    signal: signal,
    success: function(data) {
      hide_loading_modal();
      console.log(data);
      document.getElementById('gpt-answer').value = data.answer;
    }
  });
});
</script>
{% endif %}

{% endblock content %}
