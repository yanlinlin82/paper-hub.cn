<div class="modal fade" id="reviewModal" data-bs-backdrop="static" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center" id="reviewModalLabel">Edit review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reviewEditForm" method="post">
          {% csrf_token %}
          <input type="hidden" id="reviewModalPk">
          <div class="row mb-3">
            <div class="col-6 form-group">
              <label class="mt-3" for="reviewModalUsername">Username</label>
              <input type="text" class="form-control" id="reviewModalUsername" name="reviewModalUsername" required disabled>
            </div>
            <div class="col-6 form-group">
              <label class="mt-3" for="reviewModalCreateTime">Create Time</label>
              <input type="text" class="form-control" id="reviewModalCreateTime" name="reviewModalCreateTime" required disabled>
            </div>
          </div>
          <div class="row">
            <div class="col-6 form-group">
              <label class="mt-3" for="reviewModalreviewID">review ID</label>
              <div class="input-group w-auto">
                <input type="text" class="form-control" id="reviewModalreviewID" name="reviewModalreviewID" required placeholder="DOI/PMID/PMCID/arXivID">
                <button type="button" class="btn btn-primary" id="reviewModalQuery">Query</button>
              </div>
            </div>
            <div class="col-2 form-group">
              <label class="mt-3" for="reviewModalPubYear">Pub Year</label>
              <input type="text" class="form-control" id="reviewModalPubYear" name="reviewModalPubYear" required>
            </div>
            <div class="col-4 form-group">
              <label class="mt-3" for="reviewModalJournal">Journal</label>
              <input type="text" class="form-control" id="reviewModalJournal" name="reviewModalJournal" required>
            </div>
          </div>
          <div class="form-group mb-3">
            <label class="mt-3" for="reviewModalTitle">Title</label>
            <input type="text" class="form-control" id="reviewModalTitle" name="reviewModalTitle" required>
          </div>
          <div class="form-group">
            <label class="mt-3" for="reviewModalComment">Comment</label>
            <textarea class="form-control" id="reviewModalComment" name="reviewModalComment" rows="10"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="reviewModalSave">Save</button>
      </div>
    </div>
  </div>
</div>
<script>
function get_review_id(id) {
  var review_id = '';
  if ($('#review-doi-' + id)) {
    review_id = $('#review-doi-' + id).text();
  } else if ($('#review-pmid-' + id)) {
    review_id = $('#review-pmid-' + id).text();
  } else if ($('#review-pmcid-' + id)) {
    review_id = $('#review-pmcid-' + id).text();
  } else if ($('#review-arxiv-id-' + id)) {
    review_id = $('#review-arxiv-id-' + id).text();
  } else if ($('#review-cnki-id-' + id)) {
    review_id = $('#review-cnki-id-' + id).text();
  }
  return review_id;
}

function edit_review(id) {
  $('#reviewModalLabel').text('Edit review');
  $('#reviewModalUsername').prop("disabled", true);
  $('#reviewModalCreateTime').prop("disabled", true);
  $('#reviewModalPk').val(id);
  $('#reviewModalUsername').val($('#review-user-' + id).text());
  $('#reviewModalCreateTime').val($('#review-create-time-' + id).text());
  $('#reviewModalreviewID').val(get_review_id(id));
  $('#reviewModalTitle').val($('#review-title-' + id).text());
  $('#reviewModalPubYear').val($('#review-pub-year-' + id).text());
  $('#reviewModalJournal').val($('#review-journal-' + id).text());
  $('#reviewModalComment').val($('#review-comment-' + id).text());
  $('#reviewModal').modal('show');
}

function add_review() {
  $('#reviewModalLabel').text('Add review');
  $('#reviewModalUsername').prop("disabled", false);
  $('#reviewModalCreateTime').prop("disabled", false);
  $('#reviewModalPk').val('');
  $('#reviewModalUsername').val('');
  $('#reviewModalCreateTime').val('');
  $('#reviewModalreviewID').val('');
  $('#reviewModalTitle').val('');
  $('#reviewModalPubYear').val('');
  $('#reviewModalJournal').val('');
  $('#reviewModalComment').val('');
  $('#reviewModal').modal('show');
}

$(document).ready(function() {
  $('#reviewModal').on('shown.bs.modal', () => {
    if ($('#reviewModalLabel').text() == 'Add review') {
      $('#reviewModalUsername').focus();
    } else {
      $('#reviewModalreviewID').focus();
    }
  })

  $('#reviewModalQuery').click(function () {
    review_id = $('#reviewModalreviewID').val();
    url = "{% url 'api:query_review' 'xxxxxx' %}".replace('xxxxxx', review_id);
    $.ajax({
      url: url,
      success: function (data) {
        if (!data.success) {
          alert('Failed to query review info by ID (' + review_id + ').\n' + data.error);
        } else {
          $('#reviewModalTitle').val(data.results.title);
          $('#reviewModalPubYear').val(data.results.pub_year);
          $('#reviewModalJournal').val(data.results.journal);
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    })
  })

  function ajax_add_review() {
    $.ajax({
      url: "{% url 'api:add_review' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: {
        group_name: '{{group.name}}',
        username: $('#reviewModalUsername').val(),
        create_time: $('#reviewModalCreateTime').val(),
        review_id: $('#reviewModalreviewID').val(),
        title: $('#reviewModalTitle').val(),
        pub_year: $('#reviewModalPubYear').val(),
        journal: $('#reviewModalJournal').val(),
        comment: $('#reviewModalComment').val()
      },
      success: function (data) {
        if (!data.success) {
          alert('Add review failed!\n' + data.error);
        } else {
          location.reload(false);
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    })
  }

  function ajax_edit_review() {
    $.ajax({
      url: "{% url 'api:edit_review' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: {
        id: $('#reviewModalPk').val(),
        review_id: $('#reviewModalreviewID').val(),
        title: $('#reviewModalTitle').val(),
        pub_year: $('#reviewModalPubYear').val(),
        journal: $('#reviewModalJournal').val(),
        comment: $('#reviewModalComment').val()
      },
      success: function (data) {
        if (!data.success) {
          alert('Edit review failed!\n' + data.error);
        } else {
          location.reload(false);
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    })
  }

  $('#reviewModalSave').click(function () {
    if ($('#reviewModalLabel').text() == 'Add review') {
      ajax_add_review();
    } else {
      ajax_edit_review();
    }
  })
})

function delete_review(id) {
  if (confirm('Are you sure to delete the item?')) {
    $.ajax({
      url: "{% url 'api:delete_review' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { review_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Delete review failed!\n' + data.error);
        } else {
          {% if current_page == 'review' %}
          location.href = "{% url 'group:all' group_name=group.name %}";
          {% else %}
          location.reload(false);
          {% endif %}
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}

function restore_review(id) {
  $.ajax({
    url: "{% url 'api:restore_review' %}",
    type: 'POST',
    headers: { "X-CSRFToken": '{{csrf_token}}' },
    data: { review_id: id },
    success: function (data) {
      if (!data.success) {
        alert('Restore review failed!\n' + data.error);
      } else {
        location.reload(false);
      }
    },
    error: function () {
      alert('An error occurred while processing your request.');
    }
  });
}

function delete_review_forever(id) {
  if (confirm('Are you sure to delete the item forever?')) {
    $.ajax({
      url: "{% url 'api:delete_review_forever' %}",
      type: 'POST',
      headers: { "X-CSRFToken": '{{csrf_token}}' },
      data: { review_id: id },
      success: function (data) {
        if (!data.success) {
          alert('Delete review failed!\n' + data.error);
        } else {
          location.reload(false);
        }
      },
      error: function () {
        alert('An error occurred while processing your request.');
      }
    });
  }
}
</script>
