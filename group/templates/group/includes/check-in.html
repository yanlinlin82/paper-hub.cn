{% if user.is_authenticated %}
<div>
  <div class="text-center m-2">
    <button id="buttonCheckIn" class="btn btn-warning">分享打卡</button>
  </div>
</div>

<div class="modal fade" id="checkInModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="checkInModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkInModalDialogTitle">文献分享打卡</h5>
        {% if user.is_superuser %}
        <div class="flex-fill"></div>
        <div class="me-3 form-check form-switch">
          <input class="form-check-input" type="checkbox" id="switchCheckInByAdmin">
          <label class="form-check-label" for="switchCheckInByAdmin">管理员补录</label>
        </div>
        {% endif %}      
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3 align-items-center mb-3">
            <div class="col-2"></div>
            <div class="col-2">
              <label class="form-label" for="checkInModalPaperID">文献ID：</label>
            </div>
            <div class="col-6">
              <div class="input-group">
                <input type="text" class="form-control" id="checkInModalPaperID" placeholder="DOI/PMID/PMCID/arXivID">
                <button id="checkInModalQuery" type="button" class="btn btn-primary">提取文献信息</button>
              </div>
            </div>
            <div class="col-2"></div>
          </div>
          <div class="border p-3">
            <div class="row g-3 align-items-center mb-3">
              <div class="col-10 pt-3">
                <div id="checkInModalMessage" class="text-danger">请在上方输入文献ID，通过点击“提取文献信息”按钮，来自动获取文献信息。或者也可以点击右方的“手动输入”按钮，手动输入文献信息。</div>
                <div id="checkInModalPaperInfo" class="d-none"></div>
              </div>
              <div class="col-2 text-end">
                <button id="checkInModalInput" type="button" class="btn btn-primary">手动输入</button>
              </div>
            </div>
            <div id="checkInModalPaperInfoInput" class="d-none">
              <hr>
              <!-- row-1: 标题 -->
              <div class="row g-3 align-items-center mb-3">
                <div class="col-2 text-end">
                  <label class="col-form-label" for="checkInModalTitle">标题：</label>
                </div>
                <div class="col-10">
                  <input type="text" class="form-control" id="checkInModalTitle" name="title" required>
                </div>
              </div>
              <!-- row-2: 杂志、发表日期 -->
              <div class="row g-3 align-items-center mb-3">
                <div class="col-2 text-end">
                  <label class="col-form-label" for="checkInModalJournal">杂志：</label>
                </div>
                <div class="col-3">
                  <input type="text" class="form-control" id="checkInModalJournal" name="journal" required>
                </div>
                <div class="col-2 text-end">
                  <label class="col-form-label" for="checkInModalPubDate">发表日期：</label>
                </div>
                <div class="col-3">
                  <input type="text" class="form-control" id="checkInModalPubDate" name="pub_date" required>
                </div>
                <div class="col-2 text-end">
                  <button id="checkInModalInputMore" type="button" class="btn btn-primary">显示更多</button>
                </div>
              </div>
              <!-- END -->
              <div id="checkInModalPaperInfoInputDetail" class="d-none">
                <!-- 作者 -->
                <div class="row g-3 align-items-center mb-3">
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalAuthors">作者：</label>
                  </div>
                  <div class="col-10">
                    <textarea class="form-control" id="checkInModalAuthors" name="authors" rows="2" required></textarea>
                  </div>
                </div>
                <!-- 机构 -->
                <div class="row g-3 align-items-center mb-3">
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalAffiliations">机构：</label>
                  </div>
                  <div class="col-10">
                    <textarea class="form-control" id="checkInModalAffiliations" name="affiliations" rows="2" required></textarea>
                  </div>
                </div>
                <!-- 摘要 -->
                <div class="row g-3 align-items-center mb-3">
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalAbstract">摘要：</label>
                  </div>
                  <div class="col-10">
                    <textarea class="form-control" id="checkInModalAbstract" name="abstract" rows="3" required></textarea>
                  </div>
                </div>
                <!-- 关键词 -->
                <div class="row g-3 align-items-center mb-3">
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalKeywords">关键词：</label>
                  </div>
                  <div class="col-10">
                    <textarea class="form-control" id="checkInModalKeywords" name="keywords" rows="2" required></textarea>
                  </div>
                </div>
                <!-- 链接 -->
                <div class="row g-3 align-items-center mb-3">
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalURLs">链接：</label>
                  </div>
                  <div class="col-10">
                    <textarea class="form-control" id="checkInModalURLs" name="urls" rows="2" required></textarea>
                  </div>
                </div>
                <!-- 文献编号（DOI、PMID等）、语言 -->
                <div class="row g-3 align-items-center mb-3">
                  <!-- DOI -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalDOI">DOI：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalDOI" name="doi" required>
                  </div>
                  <!-- PMID -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalPMID">PMID：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalPMID" name="pmid" required>
                  </div>
                  <!-- arXiv ID -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalArXivID">arXiv ID：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalArXivID" name="arxiv_id" required>
                  </div>
                </div>
                <div class="row g-3 align-items-center mb-3">
                  <!-- PMCID -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalPMCID">PMCID：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalPMCID" name="pmcid" required>
                  </div>
                  <!-- CNKI ID -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalCNKIID">CNKI ID：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalCNKIID" name="cnki_id" required>
                  </div>
                  <!-- 语言 -->
                  <div class="col-2 text-end">
                    <label class="form-label text-end" for="checkInModalLanguage">语言：</label>
                  </div>
                  <div class="col-2">
                    <input type="text" class="form-control" id="checkInModalLanguage" name="language" required>
                  </div>
                </div>
                <!-- END -->
              </div>
            </div>
          </div>
          <div class="row g-3 align-items-center m-3 d-none" id="checkInModalCreatorAndTime">
            <div class="col-2 text-end">
              <label class="col-form-label" for="checkInModalUser">打卡人：</label>
            </div>
            <div class="col-3">
              <input class="form-control" type="text" id="checkInModalUser" name="user" value="{{ user.username }}">
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  var userInput = document.getElementById('checkInModalUser');
                  if (!userInput) return;
                  
                  var autocompleteList = null;
                  var currentRequest = null;
                  
                  userInput.addEventListener('input', function() {
                    var term = this.value;
                    if (term.length < 1) {
                      hideAutocomplete();
                      return;
                    }
                    
                    // Cancel previous request
                    if (currentRequest) {
                      currentRequest.abort();
                    }
                    
                    // Create new request
                    currentRequest = new XMLHttpRequest();
                    currentRequest.open('GET', "{% url 'api:username_autocomplete' %}?term=" + encodeURIComponent(term), true);
                    currentRequest.onreadystatechange = function() {
                      if (currentRequest.readyState === 4 && currentRequest.status === 200) {
                        try {
                          var data = JSON.parse(currentRequest.responseText);
                          showAutocomplete(data);
                        } catch (e) {
                          console.error('Error parsing autocomplete response:', e);
                        }
                      }
                    };
                    currentRequest.send();
                  });
                  
                  function showAutocomplete(items) {
                    hideAutocomplete();
                    
                    autocompleteList = document.createElement('ul');
                    autocompleteList.className = 'autocomplete-list';
                    autocompleteList.style.cssText = 'position: absolute; z-index: 2050; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; width: 100%; list-style: none; padding: 0; margin: 0;';
                    
                    items.forEach(function(item) {
                      var li = document.createElement('li');
                      li.textContent = item.value || item;
                      li.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;';
                      li.addEventListener('click', function() {
                        userInput.value = item.value || item;
                        hideAutocomplete();
                      });
                      li.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f5f5f5';
                      });
                      li.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                      });
                      autocompleteList.appendChild(li);
                    });
                    
                    userInput.parentNode.style.position = 'relative';
                    userInput.parentNode.appendChild(autocompleteList);
                  }
                  
                  function hideAutocomplete() {
                    if (autocompleteList) {
                      autocompleteList.remove();
                      autocompleteList = null;
                    }
                  }
                  
                  // Hide autocomplete when clicking outside
                  document.addEventListener('click', function(e) {
                    if (!userInput.contains(e.target) && (!autocompleteList || !autocompleteList.contains(e.target))) {
                      hideAutocomplete();
                    }
                  });
                });
              </script>
            </div>
            <div class="col-2 text-end">
              <label class="col-form-label" for="checkInModalDate">打卡时间：</label>
            </div>
            <div class="col-5">
              <div class="input-group">
                <input type="date" class="form-control" id="checkInModalDate" name="date" required>
                <input type="time" class="form-control" id="checkInModalTime" name="time" required>
              </div>
            </div>
          </div>
          <div class="row g-3 align-items-center">
            <div class="form-group text-start">
              <label class="mt-3" for="checkInModalComment">评论：</label>
              <textarea class="form-control my-2" id="checkInModalComment" name="comment" rows="6"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="checkInModalOK">提交</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var buttonCheckIn = document.getElementById('buttonCheckIn');
    if (buttonCheckIn) {
      buttonCheckIn.addEventListener('click', function() {
        checkIn();
      });
    }

    var switchCheckInByAdmin = document.getElementById('switchCheckInByAdmin');
    if (switchCheckInByAdmin) {
      switchCheckInByAdmin.addEventListener('change', function() {
        var creatorAndTime = document.getElementById('checkInModalCreatorAndTime');
        if (creatorAndTime) {
          if (this.checked) {
            creatorAndTime.classList.remove('d-none');
          } else {
            creatorAndTime.classList.add('d-none');
          }
        }
      });
    }

    var checkInModalInput = document.getElementById('checkInModalInput');
    if (checkInModalInput) {
      checkInModalInput.addEventListener('click', function() {
        var paperInfoInput = document.getElementById('checkInModalPaperInfoInput');
        if (paperInfoInput) {
          if (paperInfoInput.classList.contains('d-none')) {
            paperInfoInput.classList.add('d-block');
            paperInfoInput.classList.remove('d-none');
          } else {
            paperInfoInput.classList.add('d-none');
            paperInfoInput.classList.remove('d-block');
          }
        }
      });
    }

    var checkInModalInputMore = document.getElementById('checkInModalInputMore');
    if (checkInModalInputMore) {
      checkInModalInputMore.addEventListener('click', function() {
        var paperInfoInputDetail = document.getElementById('checkInModalPaperInfoInputDetail');
        if (paperInfoInputDetail) {
          if (paperInfoInputDetail.classList.contains('d-none')) {
            this.textContent = '收起更多';
            paperInfoInputDetail.classList.add('d-block');
            paperInfoInputDetail.classList.remove('d-none');
          } else {
            this.textContent = '显示更多';
            paperInfoInputDetail.classList.add('d-none');
            paperInfoInputDetail.classList.remove('d-block');
          }
        }
      });
    }

    function refreshPaperInfoDisplay() {
      var paperInfo = document.getElementById('checkInModalPaperInfo');
      var message = document.getElementById('checkInModalMessage');
      
      if (paperInfo && paperInfo.classList.contains('d-none')) {
        if (message) {
          message.classList.add('d-none');
          message.classList.remove('d-block');
        }
        paperInfo.classList.add('d-block');
        paperInfo.classList.remove('d-none');
      }
      
      var journal = document.getElementById('checkInModalJournal');
      var pubDate = document.getElementById('checkInModalPubDate');
      var title = document.getElementById('checkInModalTitle');
      
      var journalValue = journal ? journal.value : '';
      var pubDateValue = pubDate ? pubDate.value : '';
      var titleValue = title ? title.value : '';
      
      var html = '<div>';
      if (journalValue) {
        html += '<i>' + journalValue + '</i>, ';
      }
      if (pubDateValue) {
        html += pubDateValue + '. ';
      }
      html += '</div>';
      html += '<div><b>' + titleValue + '</b></div>';
      
      if (paperInfo) {
        paperInfo.innerHTML = html;
      }
    }

    var journalInput = document.getElementById('checkInModalJournal');
    var pubDateInput = document.getElementById('checkInModalPubDate');
    var titleInput = document.getElementById('checkInModalTitle');
    
    if (journalInput) {
      journalInput.addEventListener('input', refreshPaperInfoDisplay);
    }
    if (pubDateInput) {
      pubDateInput.addEventListener('input', refreshPaperInfoDisplay);
    }
    if (titleInput) {
      titleInput.addEventListener('input', refreshPaperInfoDisplay);
    }

    var checkInModalQuery = document.getElementById('checkInModalQuery');
    if (checkInModalQuery) {
      checkInModalQuery.addEventListener('click', function() {
        show_loading_modal('正在查询文献信息……',
            true, '取消',
            function() { hide_loading_modal(); });
        var identifierInput = document.getElementById('checkInModalPaperID');
        var identifier = identifierInput ? identifierInput.value : '';
        
        ajaxPostJson({
          url: "{% url 'api:query_paper_info' %}",
          data: { 'identifier': identifier },
          success: function (data) {
            hide_loading_modal();
            if (!data.success) {
              alert('Failed to query paper info by ID (' + identifier + ').\n' + data.error);
            } else {
              console.log(data.results);
              var titleField = document.getElementById('checkInModalTitle');
              var journalField = document.getElementById('checkInModalJournal');
              var pubDateField = document.getElementById('checkInModalPubDate');
              var authorsField = document.getElementById('checkInModalAuthors');
              var affiliationsField = document.getElementById('checkInModalAffiliations');
              var abstractField = document.getElementById('checkInModalAbstract');
              var keywordsField = document.getElementById('checkInModalKeywords');
              var urlsField = document.getElementById('checkInModalURLs');
              var doiField = document.getElementById('checkInModalDOI');
              var pmidField = document.getElementById('checkInModalPMID');
              var arxivField = document.getElementById('checkInModalArXivID');
              var pmcidField = document.getElementById('checkInModalPMCID');
              var cnkiField = document.getElementById('checkInModalCNKIID');
              var languageField = document.getElementById('checkInModalLanguage');
              
              if (titleField) titleField.value = data.results.title || '';
              if (journalField) journalField.value = data.results.journal || '';
              if (pubDateField) pubDateField.value = data.results.pub_date || '';
              if (authorsField) authorsField.value = data.results.authors ? data.results.authors.join('\n') : '';
              if (affiliationsField) affiliationsField.value = data.results.affiliations ? data.results.affiliations.join('\n') : '';
              if (abstractField) abstractField.value = data.results.abstract || '';
              if (keywordsField) keywordsField.value = data.results.keywords ? data.results.keywords.join('\n') : '';
              if (urlsField) urlsField.value = data.results.urls ? data.results.urls.join('\n') : '';
              if (doiField) doiField.value = data.results.doi || '';
              if (pmidField) pmidField.value = data.results.pmid || '';
              if (arxivField) arxivField.value = data.results.arxiv_id || '';
              if (pmcidField) pmcidField.value = data.results.pmcid || '';
              if (cnkiField) cnkiField.value = data.results.cnki_id || '';
              if (languageField) languageField.value = data.results.language || '';
              
              refreshPaperInfoDisplay();
            }
          },
          always: function() {
            console.log('Querying paper info by ID (' + identifier + ') done.');
            hide_loading_modal();
          }
        });
      });
    }
  });

  function setPaperInfoValue(field, value) {
    var element = document.getElementById(field);
    if (element) {
      element.textContent = value;
    }
  }

  function confirmPaperInputed() {
    var titleField = document.getElementById('checkInModalTitle');
    var journalField = document.getElementById('checkInModalJournal');
    var pubDateField = document.getElementById('checkInModalPubDate');
    
    var title = titleField ? titleField.value : '';
    var journal = journalField ? journalField.value : '';
    var pub_date = pubDateField ? pubDateField.value : '';
    
    if (!title || !journal || !pub_date) {
      alert('请先通过ID查询文献信息，或手工填写必要的文献信息！');
      var paperIDField = document.getElementById('checkInModalPaperID');
      if (paperIDField) {
        paperIDField.focus();
      }
      return false;
    }

    var commentField = document.getElementById('checkInModalComment');
    var comment = commentField ? commentField.value : '';
    if (!comment) {
      alert('请填写评论！');
      if (commentField) {
        commentField.focus();
      }
      return false;
    }
    return true;
  }

  function confirmUserAndDate() {
    var userField = document.getElementById('checkInModalUser');
    var user = userField ? userField.value : '';
    if (!user) {
      alert('请填写打卡人！');
      if (userField) {
        userField.focus();
      }
      return false;
    }
    var dateField = document.getElementById('checkInModalDate');
    var date = dateField ? dateField.value : '';
    if (!date) {
      alert('请填写打卡时间！');
      if (dateField) {
        dateField.focus();
      }
      return false;
    }
    return true;
  }

  function cleanUpCheckInModal() {
    var fields = [
      'checkInModalPaperID', 'checkInModalTitle', 'checkInModalJournal', 'checkInModalPubDate',
      'checkInModalAuthors', 'checkInModalAffiliations', 'checkInModalAbstract', 'checkInModalKeywords',
      'checkInModalURLs', 'checkInModalDOI', 'checkInModalPMID', 'checkInModalArXivID',
      'checkInModalPMCID', 'checkInModalCNKIID', 'checkInModalLanguage', 'checkInModalComment'
    ];
    
    fields.forEach(function(fieldId) {
      var field = document.getElementById(fieldId);
      if (field) {
        field.value = '';
      }
    });

    var message = document.getElementById('checkInModalMessage');
    var paperInfo = document.getElementById('checkInModalPaperInfo');
    var paperInfoInput = document.getElementById('checkInModalPaperInfoInput');
    var paperInfoInputDetail = document.getElementById('checkInModalPaperInfoInputDetail');
    
    if (message) {
      message.classList.add('d-block');
      message.classList.remove('d-none');
    }
    if (paperInfo) {
      paperInfo.classList.add('d-none');
      paperInfo.classList.remove('row');
    }
    if (paperInfoInput) {
      paperInfoInput.classList.add('d-none');
      paperInfoInput.classList.remove('row');
    }
    if (paperInfoInputDetail) {
      paperInfoInputDetail.classList.add('d-none');
      paperInfoInputDetail.classList.remove('row');
    }
  }

  function checkIn() {
    var dialogTitle = document.getElementById('checkInModalDialogTitle');
    if (dialogTitle) {
      dialogTitle.textContent = '文献分享打卡';
    }
    cleanUpCheckInModal();
    
    var checkInModal = document.getElementById('checkInModal');
    if (checkInModal) {
      var modal = new bootstrap.Modal(checkInModal);
      modal.show();
    }
    
    var checkInModalOK = document.getElementById('checkInModalOK');
    if (checkInModalOK) {
      // Remove existing click listeners and add new one
      checkInModalOK.replaceWith(checkInModalOK.cloneNode(true));
      checkInModalOK = document.getElementById('checkInModalOK');
      
      checkInModalOK.addEventListener('click', function() {
        if (!confirmPaperInputed()) {
          return;
        }
        {% if user.is_superuser %}
        var switchCheckInByAdmin = document.getElementById('switchCheckInByAdmin');
        if (switchCheckInByAdmin && switchCheckInByAdmin.checked) {
          if (!confirmUserAndDate()) {
            return;
          }
        }
        {% endif %}
        
        var titleField = document.getElementById('checkInModalTitle');
        var journalField = document.getElementById('checkInModalJournal');
        var pubDateField = document.getElementById('checkInModalPubDate');
        var authorsField = document.getElementById('checkInModalAuthors');
        var affiliationsField = document.getElementById('checkInModalAffiliations');
        var abstractField = document.getElementById('checkInModalAbstract');
        var keywordsField = document.getElementById('checkInModalKeywords');
        var urlsField = document.getElementById('checkInModalURLs');
        var doiField = document.getElementById('checkInModalDOI');
        var pmidField = document.getElementById('checkInModalPMID');
        var arxivField = document.getElementById('checkInModalArXivID');
        var pmcidField = document.getElementById('checkInModalPMCID');
        var cnkiField = document.getElementById('checkInModalCNKIID');
        var languageField = document.getElementById('checkInModalLanguage');
        var commentField = document.getElementById('checkInModalComment');
        
        var data = {
          "paper": {
            "title": titleField ? titleField.value : '',
            "journal": journalField ? journalField.value : '',
            "pub_date": pubDateField ? pubDateField.value : '',
            "authors": authorsField ? authorsField.value : '',
            "affiliations": affiliationsField ? affiliationsField.value : '',
            "abstract": abstractField ? abstractField.value : '',
            "keywords": keywordsField ? keywordsField.value : '',
            "urls": urlsField ? urlsField.value : '',
            "doi": doiField ? doiField.value : '',
            "pmid": pmidField ? pmidField.value : '',
            "arxiv_id": arxivField ? arxivField.value : '',
            "pmcid": pmcidField ? pmcidField.value : '',
            "cnki_id": cnkiField ? cnkiField.value : '',
            "language": languageField ? languageField.value : ''
          },
          "comment": commentField ? commentField.value : ''
        };
        
        {% if user.is_superuser %}
        var switchCheckInByAdmin = document.getElementById('switchCheckInByAdmin');
        if (switchCheckInByAdmin && switchCheckInByAdmin.checked) {
          var userField = document.getElementById('checkInModalUser');
          var dateField = document.getElementById('checkInModalDate');
          var timeField = document.getElementById('checkInModalTime');
          data.user = userField ? userField.value : '';
          data.check_in_time = (dateField ? dateField.value : '') + ' ' + (timeField ? timeField.value : '');
          var url = "{% url 'api:check_in_by_admin' %}";
        } else {
          var url = "{% url 'api:check_in' %}";
        }
        {% else %}
        var url = "{% url 'api:check_in' %}";
        {% endif %}
        
        ajaxPostJson({
          url: url,
          data: data,
          success: function(data) {
            if (!data.success) {
              if (data.error.startsWith("User not found:")) {
                var userField = document.getElementById('checkInModalUser');
                var username = userField ? userField.value : '';
                if (confirm('User not found: ' + username + '\nDo you want to create a new user?')) {
                  ajaxPostJson({
                    url: '{% url 'api:create_user' %}',
                    data: { 'username': username },
                    success: function(data) {
                      if (!data.success) {
                        alert('Failed to create user.\n' + data.error);
                      } else {
                        alert('User created successfully. Please checkin again.');
                      }
                    }
                  });
                }
              } else {
                alert('Failed to checkin.\n' + data.error);
              }
            } else {
              console.log(data.results);
              if (checkInModal) {
                var modal = bootstrap.Modal.getInstance(checkInModal);
                if (modal) {
                  modal.hide();
                }
              }
              location.reload();
            }
          }
        });
      });
    }
  }
</script>
{% endif %}
